// Copyright (c) Nolann Morenc√©. All rights reserved.
// Licensed under the MIT License. See LICENSE in the project root for license information.
import fs from"fs";import path from"path";import{pipeline,env}from"@huggingface/transformers";import CONFIG from"../config.json"with{type:"json"};const EXCLUDED_DIR=["node_modules",".git","dist","build",".next","out"],INCLUDED_FILE=[".html",".js",".css",".yml",".cs"],MAX_FILE_CHARS=9999,OUTPUT_DIR="./docs",REMOTE_MODELS={"qwen2.5-coder-3b":{name:"onnx-community/Qwen2.5-Coder-3B-Instruct",dtype:"q4"},"deepseek-coder-1.3b":{name:"onnx-community/DeepSeek-Coder-1.3B-Instruct",dtype:"q4"}},MODEL_CONFIG={mode:CONFIG.model.mode,remote:CONFIG.model.path===""?"qwen2.5-coder-3b":REMOTE_MODELS[CONFIG.model.path],local:{path:CONFIG.model.path}},getModelConfig=()=>"local"===MODEL_CONFIG.mode?(env.allowRemoteModels=!1,MODEL_CONFIG.local.path):(env.allowRemoteModels=!0,MODEL_CONFIG.remote.name);function scan(e,n,o=[]){for(const t of fs.readdirSync(e,{withFileTypes:!0}))t.isDirectory()&&!EXCLUDED_DIR.includes(t.name)?scan(path.join(e,t.name),n,o):t.isFile()&&INCLUDED_FILE.includes(path.extname(t.name))&&!n.includes(t.name)&&o.push(path.join(e,t.name));return o}function groupByDirectory(e,n){const o={};for(const t of n){const n=path.relative(e,path.dirname(t)).replace(/^[\\/]/,"")||"/";o[n]||(o[n]=[]),o[n].push(t)}return o}function groupByFile(e){const n={};for(const o of e){n[path.basename(o)]=[o]}return n}function formatToJSON(e,n="fr-FR"){const o=DOC_I18N[n]??DOC_I18N["fr-FR"];return`## ${o.component} ${e.MODULE}\n\n### ${o.role}\n\n${e.ROLE_DU_MODULE}\n\n### ${o.description}\n\n${e.DESCRIPTION}\n\n### ${o.interactions}\n\n| ${o.table.name} | ${o.table.type} | ${o.table.description} |\n| --- | ---- | ----------- |\n${e.INTERACTIONS_ET_REGLES.map(e=>`| ${e.NOM} | ${e.TYPE} | ${e.DESCRIPTION} |`).join("\n")}`}async function summarizeFolder(e,n,o,t=0){if(3==t)return void console.log(`[${(new Date).toLocaleString()}] ‚ùå Generation √©chou√©e module : ${n}`);const r=o.map(e=>{try{return`FICHIER: ${e}\n${fs.readFileSync(e,"utf8").slice(0,9999)}`}catch{return""}}).join("\n\n---\n\n"),s=[{role:"system",content:"Tu es un parseur syntaxique.\n            Tu produis UNIQUEMENT du JSON valide.\n            Si une information n'existe pas, retourne un tableau vide.\n            N'utilise jamais de texte libre.\n            Tu dois TERMINER ta r√©ponse par </JSON>.\n            Si tu n'as plus de tokens, ne commence PAS une nouvelle cl√©.\n            TOUTES les valeurs textuelles doivent √™tre r√©dig√©es dans la langue LANGUE.\n            \n            IL Y A TOUJOURS DU CODE A ANALYSER.\n            TU DOIS UNIQUEMENT √âCRIRE ENTRE <JSON> ET </JSON>.\n            TOUT TEXTE EN DEHORS SERA IGNOR√â."},{role:"user",content:`<JSON>\n            {\n                "LANGUE": ${CONFIG.language??"fr-FR"}\n                "MODULE": "${n}",\n                "ROLE_DU_MODULE": "...",\n                "DESCRIPTION": "...",\n                "INTERACTIONS_ET_REGLES": [\n                    {\n                        "NOM": "...",\n                        "TYPE": "...",\n                        "DESCRIPTION": "..."\n                    }, ...\n                ]\n            }\n            </JSON>\n            \n            ${CONFIG.context?`CONTEXTE DU PROJET : ${CONFIG.context}`:""}\n\n            SOURCE √Ä ANALYSER (NE PAS REPRODUIRE) :\n            ${r}`}],i=await e(s,{max_new_tokens:999,temperature:0,do_sample:!1});i[0].generated_text.at(-1).content.match(/<JSON>([\s\S]*?)<\/JSON>/g)||summarizeFolder(e,n,o,t+1);const c=i[0].generated_text.at(-1).content.replace(/<JSON>\n|\n<\/JSON>/g,"");return formatToJSON(JSON.parse(c.replace(/\\/g,"/")))}const toSnakeCase=e=>e.toLowerCase().trim().replace(/\s+/g,"_");async function run(){console.log("üîß Chargement du mod√®le...");const e=await pipeline("text-generation",getModelConfig(),"remote"===MODEL_CONFIG.mode?{dtype:MODEL_CONFIG.remote.dtype}:{});fs.rmSync("./docs",{recursive:!0,force:!0}),fs.existsSync("././docs/index.js")&&fs.rmSync("././docs/index.js"),fs.existsSync("./docs")||fs.mkdirSync("./docs");let n={};for(const o of CONFIG.projects){console.log(`üîçÔ∏è Scan du projet ${o.name}...`);const t=scan(o.path,o.excluded??[]);console.log(`üìÑ ${t.length} fichiers d√©tect√©s`),console.log("üë∑ Cr√©ation de la documentation...");const r=toSnakeCase(o.name);n[r]||(n[r]=[]);const s="file"===o.strategy?groupByFile(t):groupByDirectory(o.path,t);for(const[o,t]of Object.entries(s)){console.log(`[${(new Date).toLocaleString()}] üì¶Ô∏è Analyse du module : ${o}`);const s=`./docs/${r}/${o}`,i=await summarizeFolder(e,o,t);fs.mkdirSync(s,{recursive:!0}),fs.writeFileSync(`${s}/README.md`,i),n[r].push({title:o,path:`${s}/README.md`,content:i})}}fs.writeFileSync("././docs/index.js",`window.DOC_INDEX = ${JSON.stringify(n,null,4)};`),console.log("‚úÖ DOCUMENTATION.md g√©n√©r√©e")}run();const DOC_I18N={"fr-FR":{component:"Composant",role:"R√¥le",description:"Description",interactions:"Interactions et r√®gles",table:{name:"Nom",type:"Type",description:"Description"}},"en-US":{component:"Component",role:"Role",description:"Description",interactions:"Interactions and rules",table:{name:"Name",type:"Type",description:"Description"}},"es-ES":{component:"Componente",role:"Rol",description:"Descripci√≥n",interactions:"Interacciones y reglas",table:{name:"Nombre",type:"Tipo",description:"Descripci√≥n"}},"de-DE":{component:"Komponente",role:"Rolle",description:"Beschreibung",interactions:"Interaktionen und Regeln",table:{name:"Name",type:"Typ",description:"Beschreibung"}}};